<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Intiface Widget</title>
  <style>
    body {
      background: transparent;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #indicator {
      max-width: 256px;
      max-height: 256px;
    }
  </style>
</head>
<body>
  <img id="indicator" src="images/disconnected.png" alt="status">

  <script>
    const indicator = document.getElementById("indicator");

    const icons = {
      disconnected: "images/disconnected.png",
      connected: "images/connected.png",
      level1: "images/level1.png",
      level2: "images/level2.png",
      warning: "images/warning.png"
    };

    function setState(state) {
      indicator.src = icons[state] || icons.warning;
    }

    let ws;
    function connect() {
      ws = new WebSocket("ws://127.0.0.1:12345");

      ws.onopen = () => {
        console.log("Connected to Intiface Central");
        setState("connected");
      }

      ws.onclose = () => {
        console.log("Disconnected");
        setState("disconnected");
      }

      ws.onerror = () => {
        console.log("WebSocket error", err);
        setState("warning");
      }

      ws.onmessage = (msg) => {
        try {
          const data = JSON.parse(msg.data);

          if (data.ScalarCmd) {
            const scalars = data.ScalarCmd.Scalars || [];

            const vib = scalars.find(s => s.ActuatorType === "Vibrate");

            if (vib) {
              const level = vib.Scalar;

            if (level > 0) {
              if (level < 0.5) setState("level1");
              else setState("level2");
            } else {
              setState("connected");
            }
            }
          }

        } catch (e) {
          console.error("Parse error", e);
          setState("warning");
        }
      };
    }

    connect();
  </script>
</body>
</html>
