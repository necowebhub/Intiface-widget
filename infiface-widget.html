<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Intiface Widget</title>
  <style>
    body {
      background: transparent;
      margin: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    #indicator {
      max-width: 256px;
      max-height: 256px;
    }
  </style>
</head>
<body>
  <img id="indicator" src="images/disconnected.png" alt="status">

  <script>
    const indicator = document.getElementById("indicator");


    const icons = {
      disconnected: "images/disconnected.png",
      connected: "images/connected.png",
      level1: "images/level1.png",
      level2: "images/level2.png",
      warning: "images/warning.png"
    };

    function setState(state) {
      indicator.src = icons[state] || icons.warning;
    }

    let deviceWebsocket = new WebSocket("ws://127.0.0.1:12345");
    let deviceAddress = "A9816725B";
    let handshakePacket = {
      identifier: "LVS-Test",
      address: deviceAddress,
      version: 0
    };

    deviceWebsocket.addEventListener("open", (socket) => {
        console.log("Connected");
        setState("connected");
        deviceWebsocket.send(JSON.stringify(handshakePacket));
        console.log("Handshake Sent");
        deviceWebsocket.addEventListener("message", async (event) => {

          let msg = event.data;
          console.log(msg);
          if (msg.indexOf("DeviceType;") !== -1) {
            console.log("got device type");
            console.log(`Z:10:${deviceAddress};`);
            // Lovense initialization request
            deviceWebsocket.send(`Z:10:${deviceAddress};`);
          } else if (msg.indexOf("Battery;") !== -1) {
            console.log("Got battery");
            // Buttplug will wait for a response to Battery so just make something up.
            deviceWebsocket.send("90;");
          } else {
            console.log(`Lovense command: ${msg}`);
            // If it's a vibrate message, get the vibrate level, which will be 0-20.
            let regex = /Vibrate:([0-9]+)/;
            let match = msg.match(regex);
            if (match.length > 1) {
              if (match.length > 10) {
                console.log(match[1]);
                setState(level2);
              } else {
                console.log(match[1]);
                setState(level1);
              }
            }
            //document.getElementById("lovense-output").innerHTML = msg;
            // If we wanted to conform with the Lovense protocol we'd send "OK;" here, but Buttplug doesn't care.
          }
        });
    });
  </script>
</body>
</html>
